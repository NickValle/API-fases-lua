<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fases da lua - API</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-slate-900 to-black min-h-screen flex items-center justify-center text-white p-4 sm:p-8">

    <div class="bg-black backdrop-blur-md p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-lg flex flex-col items-center">
        <h1 class="text-center text-2xl sm:text-3xl font-bold mb-2 sm:mb-4">
            Fase da Lua
        </h1>
        <p class="text-center text-xs sm:text-sm text-gray-300 mb-4 sm:mb-6 max-w-sm">
            Basta inserir a data desejada para descobrir qual serÃ¡ a fase da lua nesse dia.
        </p>
        <input type="date" id="data-input" class="mb-6 px-4 py-2 bg-white/10 text-white rounded-full w-full text-sm sm:text-base border border-white/20 focus:border-white/50 focus:outline-none transition">
        <img id="lua-img" class="mx-auto w-64 sm:w-96 h-64 sm:h-96 mb-6 object-contain" alt="">

        <div class="w-full space-y-2 sm:space-y-3">
            <p id="fase" class="text-lg sm:text-xl font-semibold"></p>
            <p id="iluminacao" class="text-xs sm:text-sm text-gray-300"></p>
            <p id="descricao" class="text-xs sm:text-sm text-gray-400 leading-relaxed text-justify"></p>
        </div>
    </div>

    <audio id="background-music" loop>
        <source src="/music/soundMoon.mp3" type="audio/mpeg">
        Seu navegador nÃ£o suporta o elemento de Ã¡udio.
    </audio>

    <div class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6">
        <button id="audio-btn" class="px-3 sm:px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-full font-semibold transition text-sm sm:text-base whitespace-nowrap" title="Clique para ligar/desligar a mÃºsica">
            ðŸ”Š MÃºsica
        </button>
    </div>

    <script>
        // Cache simples para evitar requisiÃ§Ãµes repetidas
        const cache = {};
        const audio = document.getElementById("background-music");
        const audioBtn = document.getElementById("audio-btn");
        const dataInput = document.getElementById("data-input");
        let isPlaying = false;

        // Controle de Ã¡udio
        audioBtn.addEventListener("click", () => {
            if (isPlaying) {
                audio.pause();
                audioBtn.textContent = "ðŸ”‡ MÃºsica";
                isPlaying = false;
            } else {
                audio.play().catch(err => console.log("Autoplay bloqueado"));
                audioBtn.textContent = "ðŸ”Š MÃºsica";
                isPlaying = true;
            }
        });

        async function carregarLua(data = null) {
            try {
                const dataStr = data || new Date().toISOString().split("T")[0];
                
                // Verificar cache
                if (cache[dataStr]) {
                    exibirDados(cache[dataStr]);
                    return;
                }

                // Mostrar loading
                const faseEl = document.getElementById("fase");
                faseEl.textContent = "Carregando...";

                // Buscar dados
                const url = data ? `/lua/${data}` : `/lua`;
                const res = await fetch(url);
                
                if (!res.ok) {
                    const erro = await res.json();
                    exibirErro(erro.error || "Erro ao carregar dados");
                    return;
                }
                
                const dados = await res.json();
                
                // Armazenar em cache
                cache[dataStr] = dados;
                
                // Exibir dados
                exibirDados(dados);
            } catch (error) {
                exibirErro("Erro na conexÃ£o com o servidor");
                console.error(error);
            }
        }

        function exibirDados(dados) {
            document.getElementById("lua-img").src = `/images/${dados.imagem}`;
            document.getElementById("fase").innerText = dados.fase;
            document.getElementById("iluminacao").innerText = `IluminaÃ§Ã£o: ${dados.iluminacao}%`;
            document.getElementById("descricao").innerText = dados.descricao;
        }

        function exibirErro(mensagem) {
            document.getElementById("fase").textContent = "Erro";
            document.getElementById("iluminacao").textContent = mensagem;
            document.getElementById("descricao").textContent = "";
            console.error(mensagem);
        }

        // Event listeners
        dataInput.addEventListener("change", (e) => {
            if (e.target.value) {
                carregarLua(e.target.value);
            }
        });

        // Inicializar
        dataInput.value = new Date().toISOString().split("T")[0];
        carregarLua();
    </script>
</body>
</html>